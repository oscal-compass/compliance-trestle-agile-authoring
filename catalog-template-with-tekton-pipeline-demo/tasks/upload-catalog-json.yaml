apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: upload-catalog-json
spec:
  workspaces:
    - name: cloned-repo
  params:
    - name: repo-name
      description: The name of the repository
      type: string
    - name: user-email
      description: The email of the user
      type: string
    - name: user-name
      description: The name of the user
      type: string
  steps:
    - name: perform-actions
      image: python:latest
      script: |
        #!/bin/sh        
        echo "Copy the downloaded file to the develop branch of the repository."
        cd /workspace/cloned-repo/$(params.repo-name)        
        git checkout -b develop
        cp ../*.json ./catalogs/catalog.json

        echo "Install trestle"
        python3 -m pip install -q --upgrade pip setuptools
        python3 -m pip install -q compliance-trestle
        python3 -m pip install -q python-semantic-release==7.31.4

        echo "Generate the markdown files from catalog JSON file."
        trestle author catalog-generate -n . --output md_catalogs/catalog-folder
        echo "Assemble the markdown files into the catalog JSON file. (This step ensures that the catalog JSON file is up-to-date with the markdown files because the imported JSON file may reorder some of the fields.)"
        trestle author catalog-assemble --set-parameters --markdown md_catalogs/catalog-folder --output .

        echo "Upload the catalog JSON file and its markdowns to the repository."        
        git config --global user.email $(params.user-email)
        git config --global user.name $(params.user-name)
        git push --set-upstream origin develop
        git add .
        git commit -m "Add catalog.json and its generated markdown files." -q
        git push -q
